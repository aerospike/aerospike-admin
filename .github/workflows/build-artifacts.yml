name: build-artifacts.yml
permissions:
  contents: read
  id-token: write
  attestations: write
on:
  workflow_dispatch:
    inputs:
      GIT_TAG:
        description: "git tag on master branch only (tag must be x.y.z format, e.g. 1.2.3). Will be ignored on other branches."
        required: false
        type: string
        default: ""
      BUILD_BUILDER_IMAGES:
        description: "Build and push remote builder images to JFrog"
        required: true
        type: boolean
        default: false
      DOCKER_TAG:
        description: "Tag to use for remote builder images"
        required: true
        type: string
        default: latest
  pull_request:
    # yamllint disable-line rule:quoted-strings
    branches:
      - "*"
  push:
    branches:
      # yamllint disable-line rule:quoted-strings
      - "master"

jobs:
  validate-inputs:
    name: Validate workflow inputs
    runs-on: ubuntu-24.04
    steps:
      - name: Validate BUILD_BUILDER_IMAGES and DOCKER_TAG
        run: |
          set -euo pipefail

          # Only validate on workflow_dispatch
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "Skipping input validation (not a workflow_dispatch)"
            exit 0
          fi

          BUILD_BUILDER_IMAGES="${{ github.event.inputs.BUILD_BUILDER_IMAGES }}"
          DOCKER_TAG="${{ github.event.inputs.DOCKER_TAG }}"
          GIT_TAG="${{ github.event.inputs.GIT_TAG }}"

          # Validate: if BUILD_BUILDER_IMAGES is true, DOCKER_TAG must not be the default 'latest'
          if [[ "$BUILD_BUILDER_IMAGES" == "true" && "$DOCKER_TAG" == "latest" ]]; then
            echo "ERROR: when BUILD_BUILDER_IMAGES=true, you must explicitly specify a DOCKER_TAG (not 'latest')" >&2
            exit 1
          fi

          # Validate: if GIT_TAG is provided, it must match x.y.z format and we must be on master branch
          if [[ -n "$GIT_TAG" ]]; then
            if ! [[ "$GIT_TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "ERROR: GIT_TAG must be in x.y.z format (e.g. 1.2.3). Got: '$GIT_TAG'" >&2
              exit 1
            fi
            
            if [[ "${{ github.ref }}" != "refs/heads/master" ]]; then
              echo "ERROR: GIT_TAG can only be provided when running on master branch" >&2
              echo "Current branch: ${{ github.ref }}" >&2
              exit 1
            fi
          fi

          echo "âœ“ Input validation passed"

  create-tag:
    name: Create git tag (x.y.z)
    needs: validate-inputs
    # Only run on workflow_dispatch on master with GIT_TAG provided
    if: >-
      github.event_name == 'workflow_dispatch' &&
      github.ref == 'refs/heads/master' &&
      github.event.inputs.GIT_TAG != ''
    runs-on: ubuntu-24.04
    environment: deploy-to-master
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create and push tag
        run: |
          set -euo pipefail

          GIT_TAG="${{ github.event.inputs.GIT_TAG }}"

          git fetch --tags --force

          if git rev-parse -q --verify "refs/tags/$GIT_TAG" >/dev/null; then
            echo "Tag '$GIT_TAG' already exists; skipping creation."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$GIT_TAG" -m "$GIT_TAG" "$GITHUB_SHA"
          git push origin "refs/tags/$GIT_TAG"

  get-version:
    needs: create-tag
    # Run if create-tag succeeded OR was skipped (but not if it failed/cancelled)
    if: ${{ always() && (needs.create-tag.result == 'success' || needs.create-tag.result == 'skipped') }}
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      VERSION: ${{ steps.git_describe.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Compute version from git describe
        id: git_describe
        run: echo "version=$(git describe --tags --always --abbrev=9)" >> "$GITHUB_OUTPUT"

  build-artifacts:
    needs: get-version
    # always() needed because get-version uses always() - without it, this job would be skipped
    if: ${{ always() && needs.get-version.result == 'success' }}
    strategy:
      fail-fast: false  # Run all OS builds to see full status, but fail overall if any fails
      matrix:
        distro:
          - el8
          - el9
          - el10
          - amzn2023
          - debian11
          - debian12
          - debian13
          - ubuntu20.04
          - ubuntu22.04
          - ubuntu24.04
        host:
          - ubuntu-24.04
          - ubuntu-24.04-arm
    uses: aerospike/shared-workflows/.github/workflows/reusable_execute-build.yaml@v2.0.2
    with:
      runs-on: ${{ matrix.host }}
      jf-project: database
      jf-build-id: ${{ needs.get-version.outputs.VERSION }}
      gh-workflows-ref: "v2.0.2"
      # this is the default behaviour so we can leave it out but if it is wanted to be explicit
      # we need to use the ref not the ref_name in github actions. The ref_name is the short name and so not a valid ref.
      gh-source-ref: ${{ github.ref }}
      build-script: |
        set -euo pipefail

        echo "Logging in to artifact.aerospike.io for Docker pulls/pushes..."
        jf docker login artifact.aerospike.io

        rm -rf dist
        mkdir -p dist

        ARCH=${{ contains(matrix.host, 'arm') && 'aarch64' || 'x86_64' }} \
        BUILD_BUILDER_IMAGES=${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.BUILD_BUILDER_IMAGES) || 'false' }}  \
        IMAGE_TAG=${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.DOCKER_TAG) || 'latest' }} \
        BUILDER_IMAGE_PREFIX="artifact.aerospike.io/database-container-dev-local/aerospike-tools/" \
        local/.github/packaging/project/gha-main.sh "${{ matrix.distro }}"
      gh-artifact-directory: dist
      gh-artifact-name: unsigned-artifacts-${{ needs.get-version.outputs.VERSION }}-${{ matrix.distro }}-${{ contains(matrix.host, 'arm') && 'aarch64' || 'x86_64' }}
      gh-retention-days: 1
      dry-run: false
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike
      jf-build-name: "aerospike-asadm"

  organize-built-artifacts:
    needs: [build-artifacts, get-version]
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Download All Matrix Artifacts
        uses: actions/download-artifact@v7
        with:
          path: build-artifacts
          pattern: unsigned-artifacts-${{ needs.get-version.outputs.VERSION }}*
          merge-multiple: true
 
      - name: Upload packaged Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: unsigned-artifacts-${{ needs.get-version.outputs.VERSION }}
          path: build-artifacts
          overwrite: true
          retention-days: 1

  sign-artifacts:
    needs:
      - get-version
      - organize-built-artifacts
    uses: aerospike/shared-workflows/.github/workflows/reusable_sign-artifacts.yaml@v2.0.2
    with:
      gh-artifact-name: signed-artifacts-${{ needs.get-version.outputs.VERSION }}
      gh-unsigned-artifacts: unsigned-artifacts-${{ needs.get-version.outputs.VERSION }}
      gh-workflows-ref: "v2.0.2"
    secrets:
      gpg-private-key: ${{ secrets.GPG_SECRET_KEY }}
      gpg-public-key: ${{ secrets.GPG_PUBLIC_KEY }}
      gpg-key-pass: ${{ secrets.GPG_PASS }}

  upload-artifacts-to-jfrog:
    needs:
      - get-version
      - sign-artifacts
    uses: aerospike/shared-workflows/.github/workflows/reusable_deploy-artifacts.yaml@v2.0.2
    with:
      jf-project: database
      jf-build-name: "aerospike-asadm"
      version: ${{ needs.get-version.outputs.VERSION }}
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike
      gh-artifact-name: signed-artifacts-${{ needs.get-version.outputs.VERSION }}
      gh-retention-days: 1
      dry-run: false
      jf-build-id: ${{ needs.get-version.outputs.VERSION }}
      jf-metadata-build-id: ${{ needs.get-version.outputs.VERSION }}-metadata
      gh-workflows-ref: "v2.0.2"

  create-release-bundle:
    permissions:
      contents: read
      id-token: write
      attestations: write
    needs:
      - upload-artifacts-to-jfrog
      - get-version
    uses: aerospike/shared-workflows/.github/workflows/reusable_create-release-bundle.yaml@v2.0.2
    with:
      jf-project: "database"
      jf-build-names: "aerospike-asadm:${{ needs.get-version.outputs.VERSION }}"
      jf-bundle-name: "aerospike-asadm"
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike
      version: ${{ needs.get-version.outputs.VERSION }}
      gh-workflows-ref: v2.0.2 # Use specific shared-workflows version
      dry-run: false

  test-install-from-jfrog-and-execute:
    strategy:
      fail-fast: false  # Run all OS tests to see full status, but fail overall if any fails
      matrix:
        distro:
          - el8
          - el9
          - el10
          - amzn2023
          - debian11
          - debian12
          - debian13
          - ubuntu20.04
          - ubuntu22.04
          - ubuntu24.04
        host:
          - ubuntu-24.04
          - ubuntu-24.04-arm
    needs:
      - get-version
      - create-release-bundle
    env:
      JFROG_CLI_BUILD_NAME: ${{ github.workflow }}
      JFROG_CLI_LOG_LEVEL: INFO
      PACKAGE_NAME: asadm
      ARCH: ${{ contains(matrix.host, 'arm') && 'aarch64' || 'x86_64' }}
      BUILD_BUILDER_IMAGES: false
      BUILDER_IMAGE_PREFIX: ""
    runs-on: ${{ matrix.host }}
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Install JFrog CLI
        id: jf
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://artifact.aerospike.io
          JF_PROJECT: database
        with:
          oidc-provider-name: database-gh-aerospike
          oidc-audience: database-gh-aerospike
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref }}
          submodules: recursive

      - name: Run test cases
        env:
          JF_TOKEN: ${{ steps.jf.outputs.oidc-token }}
          JF_USERNAME: ${{ steps.jf.outputs.oidc-user }}
        run: |
          PACKAGE_NAME=${PACKAGE_NAME} \
          ARCH=${ARCH} \
          BUILD_BUILDER_IMAGES=${BUILD_BUILDER_IMAGES} \
          BUILDER_IMAGE_PREFIX=${BUILDER_IMAGE_PREFIX} \
          .github/packaging/project/test/gha-test-main.sh ${{ matrix.distro }} ${{ github.event.repository.name }} ${{ needs.get-version.outputs.VERSION }} ${PACKAGE_NAME}
